"use strict";(this["webpackChunktzw_live_watch"]=this["webpackChunktzw_live_watch"]||[]).push([[966],{1444:(e,t,o)=>{o.d(t,{A:()=>r});var i=o(50101);function s(e){return(0,i.A)({url:"/live/check-oauth-env",method:"get",params:e})}function n(e){return(0,i.A)({url:"/live/oauthRedirect",method:"post",data:e})}function l(e){return(0,i.A)({url:"/live/oauthLogin",method:"post",data:e})}const r={oauthEnvDetect:s,oauthRedirect:n,oauthLogin:l}},38291:(e,t,o)=>{o.r(t),o.d(t,{default:()=>d});var i=function(){var e=this,t=e._self._c;return t("div")},s=[],n=(o(44114),o(95353)),l=o(10248),r=o(1444),a=o(39717);const g={name:"OAuthLogin",data(){return{code:null,error:null,error_description:null,isOAuth:!1,oauthEnv:null}},computed:{...(0,n.L8)(["getUserInfo","getLiveRoomInfo","isMobile","getParentUserName","getToken"])},mounted(){this.code=this.$route.query.code,this.state=this.$route.query.state,this.error=this.$route.query.error,this.error_description=this.$route.query.error_description;let e=a.A.detectEnv();e&&(this.isOAuth=!0,this.oauthEnv=e);let t=this;if(t.checkLogin=t.checkLogin.bind(t),!this.code||!this.state)return(0,l.bI)("授权失败，请稍后再试","error"),void this.$router.push("/");t.checkLogin()},methods:{checkLogin(){const e=this.getParentUserName;let t={};this.error?this.$router.push({path:"/login",query:{error:this.error,error_description:this.error_description}}):(t.roomId=this.getLiveRoomInfo.id,t.loginType=this.isMobile?5:2,t.code=this.code,e&&(t.parentUserName=e),t.oauthType=this.oauthEnv,r.A.oauthLogin(t).then(e=>{if(console.log("获取成功:",e),"200"===e.code){const{data:t}=e;this.processLoginResponse(t)}}).catch(e=>{console.error("获取失败:",e),(0,l.bI)("用微信登陆失败","error")}))},processLoginResponse(e){let t={username:e.userInfo.userName,password:e.userInfo.password,oauthUserInfo:e.oauthUserInfo,loginType:this.isMobile?5:2};this.$store.dispatch("storeLoginInfo",t),this.$store.dispatch("setUserInfo",e.userInfo),this.$store.dispatch("setClientInfo",e.clientInfo),this.$store.dispatch("setToken",e.token),this.$store.dispatch("setForceAccountLogin",!1),this.$store.commit("setReLogin",!1),this.$router.push({path:"/liveroom",query:{pun:this.getUserInfo.userName}})}}},h=g;var u=o(81656),m=(0,u.A)(h,i,s,!1,null,"6eca32bc",null);const d=m.exports},39717:(e,t,o)=>{function i(){const e=window.navigator.userAgent.toLowerCase();return e.includes("micromessenger")?"wechat":e.includes("dingtalk")?"dingtalk":e.includes("douyin")||e.includes("tiktok")||e.includes("bytedance")?"douyin":e.includes("xiaohongshu")?"xiaohongshu":e.includes("qq/")?"qq":e.includes("weibo")?"weibo":null}function s(){const e=i();return!!e}o.d(t,{A:()=>n});const n={detectEnv:i,isInApp:s}},41729:(e,t,o)=>{o.r(t),o.d(t,{default:()=>L});var i=function(){var e=this,t=e._self._c;return t("div",{staticClass:"login-container",style:e.getLiveRoomStyle&&e.getLiveRoomStyle.loginPageStyle?e.getLiveRoomStyle.loginPageStyle:{}},[e.needPswd?t("div",{staticClass:"login-panel"},[e.getLiveRoomTheme&&e.getLiveRoomTheme.loginPageLogo?t("div",{staticClass:"head"},[t("div",{staticClass:"logo"},[t("img",{attrs:{src:e.getLiveRoomTheme.loginPageLogo||"#",alt:""}})])]):e._e(),t("el-form",{ref:"liveForm",staticClass:"login-form",style:e.getLiveRoomStyle.loginPanelStyle||{},attrs:{"label-width":"120px",rules:e.rules,model:e.live},nativeOn:{submit:function(e){e.preventDefault()}}},[t("el-form-item",{staticClass:"form-group",attrs:{label:"直播间密码:",prop:"livePswd"}},[t("span",{style:e.getLiveRoomStyle.loginLabelStyle||{},attrs:{slot:"label"},slot:"label"},[e._v("直播间密码:")]),t("el-input",{attrs:{placeholder:"请输入直播间密码"},model:{value:e.live.livePswd,callback:function(t){e.$set(e.live,"livePswd",t)},expression:"live.livePswd"}})],1),t("div",{staticClass:"form-group button-bar",style:e.getLiveRoomStyle.loginBtnBarStyle||{}},[t("el-button",{staticClass:"login-btn",style:e.getLiveRoomStyle.loginBtnStyle||{},attrs:{"native-type":"submit"},on:{click:e.handleLivePswd}},[e._v("验 证")])],1)],1)],1):e._e(),e.showLogin?t("div",{staticClass:"login-panel"},[e.getLiveRoomTheme&&e.getLiveRoomTheme.loginPageLogo?t("div",{staticClass:"head"},[t("div",{staticClass:"logo"},[t("img",{attrs:{src:e.getLiveRoomTheme.loginPageLogo||"#",alt:""}})])]):e._e(),t("el-form",{ref:"loginForm",staticClass:"login-form",class:e.isMobile&&e.getLiveRoomStyle.loginPanelMobileStyle&&e.getLiveRoomStyle.loginPanelMobileStyle.color||e.getLiveRoomStyle.loginPanelStyle&&e.getLiveRoomStyle.loginPanelStyle.color?"customer-color":"",style:e.isMobile?e.getLiveRoomStyle.loginPanelMobileStyle||e.getLiveRoomStyle.loginPanelStyle||{}:e.getLiveRoomStyle.loginPanelStyle||{},attrs:{"label-width":"80px",rules:e.rules,model:e.form},nativeOn:{submit:function(e){e.preventDefault()}}},[e.isPhoneLogin?t("el-form-item",{staticClass:"form-group",attrs:{label:"手机号:",prop:"phone"}},[t("span",{style:e.isMobile?e.getLiveRoomStyle.loginLabelMobileStyle||e.getLiveRoomStyle.loginLabelStyle||{}:e.getLiveRoomStyle.loginLabelStyle||{},attrs:{slot:"label"},slot:"label"},[e._v("手机号:")]),t("el-input",{model:{value:e.form.phone,callback:function(t){e.$set(e.form,"phone",t)},expression:"form.phone"}})],1):t("el-form-item",{staticClass:"form-group",attrs:{label:"用户名:",prop:"username"}},[t("span",{style:e.isMobile?e.getLiveRoomStyle.loginLabelMobileStyle||e.getLiveRoomStyle.loginLabelStyle||{}:e.getLiveRoomStyle.loginLabelStyle||{},attrs:{slot:"label"},slot:"label"},[e._v("用户名:")]),t("el-input",{model:{value:e.form.username,callback:function(t){e.$set(e.form,"username",t)},expression:"form.username"}})],1),t("el-form-item",{staticClass:"form-group",attrs:{label:"密 码：",prop:"password"}},[t("span",{style:e.isMobile?e.getLiveRoomStyle.loginLabelMobileStyle||e.getLiveRoomStyle.loginLabelStyle||{}:e.getLiveRoomStyle.loginLabelStyle||{},attrs:{slot:"label"},slot:"label"},[e._v("密    码:")]),t("el-input",{attrs:{type:"password"},model:{value:e.form.password,callback:function(t){e.$set(e.form,"password",t)},expression:"form.password"}})],1),t("div",{staticClass:"form-group button-bar",style:e.isMobile?e.getLiveRoomStyle.loginBtnBarMobileStyle||e.getLiveRoomStyle.loginBtnBarStyle||{}:e.getLiveRoomStyle.loginBtnBarStyle||{}},[e.isPhoneLogin?t("el-button",{staticClass:"login-btn",style:e.isMobile?e.getLiveRoomStyle.loginBtnMobileStyle||e.getLiveRoomStyle.loginBtnStyle||{}:e.getLiveRoomStyle.loginBtnStyle||{},attrs:{"native-type":"submit"},on:{click:e.handlePhoneLogin}},[e._v("手机号登录")]):e._e(),!e.isReLogin&&!e.showLogin||e.isPhoneLogin?e._e():t("el-button",{staticClass:"login-btn",style:e.isMobile?e.getLiveRoomStyle.loginBtnMobileStyle||e.getLiveRoomStyle.loginBtnStyle||{}:e.getLiveRoomStyle.loginBtnStyle||{},attrs:{"native-type":"submit"},on:{click:e.handleLogin}},[e._v("账号登录")]),e.getLiveRoomInfo.isGuestLogin&&e.isReLogin?t("el-button",{staticClass:"login-btn",style:e.isMobile?e.getLiveRoomStyle.loginBtnMobileStyle||e.getLiveRoomStyle.loginBtnStyle||{}:e.getLiveRoomStyle.loginBtnStyle||{},attrs:{"native-type":"submit"},on:{click:e.handleGuestLogin}},[e._v("游客访问")]):e._e(),e.isWxH5?t("el-button",{staticClass:"login-btn",style:e.isMobile?e.getLiveRoomStyle.loginBtnMobileStyle||e.getLiveRoomStyle.loginBtnStyle||{}:e.getLiveRoomStyle.loginBtnStyle||{},attrs:{"native-type":"submit"},on:{click:e.handleWxH5Login}},[e._v("使用微信登录")]):e._e()],1)],1)],1):e._e()])},s=[],n=(o(44114),o(95353)),l=o(93756),r=o(31428),a=o(10248),g=o(39717),h=o(1444);const u={name:"Login",data(){return{form:{username:void 0,password:void 0,loginType:2},live:{livePswd:null},needPswd:!1,showLogin:!1,guest:!1,logo:"",style:{},isPhoneLogin:!1,rules:{username:[{required:!0,message:"请输入登录名",trigger:"blur"}],phone:[{required:!0,message:"请输入手机号",trigger:"blur"}],password:[{required:!0,message:"请输入登录密码",trigger:"blur"}]},isWxH5:!1,error:null,error_description:null,parentUserName:null,isOAuth:!1,oauthEnv:null}},computed:{...(0,n.L8)(["getLoginInfo","getGuestLoginInfo","getLiveRoomInfo","getUserInfo","isGuest","getToken","getLiveRoomStyle","getLiveRoomTheme","isMulti","getMultiRoomUserInfo","isReLogin","isMobile","getClientInfo"])},created(){let e;e=this.getLiveRoomInfo&&this.getLiveRoomInfo.isGuestLogin?this.getGuestLoginInfo:this.getLoginInfo,e&&(e.username||e.phone)&&(this.form={username:"undefined"!=e.username&&"null"!=e.username?e.username:"",password:"undefined"!=e.password&&"null"!=e.password?e.password:"",phone:"undefined"!=e.phone&&"null"!=e.phone?e.phone:""},e.isPhoneLogin&&(this.isPhoneLogin=!0))},mounted(){const e=this.$route.query.pun;e&&(this.$store.commit("setParentUserName",e),this.parentUserName=e);let t=this;function o(){t.getLiveRoomInfo?t.prepare():setTimeout(()=>{o()},1e3)}t.prepare=t.prepare.bind(t),this.error=this.$route.query.error,this.error_description=this.$route.query.error_description,o=o.bind(t),o()},methods:{prepare(){if(this.getToken)return void this.$router.push({path:"/liveroom",query:{pun:this.getUserInfo.userName}});if((0,r.rj)(),this.$store.dispatch("removeToken"),!this.getLiveRoomInfo)return void(0,a.bI)("无法访问直播间，请稍后再试","error");this.getLiveRoomInfo.name&&(document.title=this.getLiveRoomInfo.name),this.getLiveRoomInfo.icon&&(document.querySelector("link[rel*='icon']").href=this.getLiveRoomInfo.icon);let e=this.getLiveRoomStyle.loginPageStyle||{};e&&e.loginPageLogo&&(this.logo=e.loginPageLogo),e&&e.loginPageBgImg&&(e.backgroundImage="url("+e.loginPageBgImg+")");let t=g.A.detectEnv();t?h.A.oauthEnvDetect({platform:t}).then(e=>{e.valid&&(this.isOAuth=!0,this.oauthEnv=t)}).catch(e=>{console.log(e)}).finally(()=>{this.nextStep()}):this.nextStep()},nextStep(){this.getLiveRoomInfo.needPswd?(this.needPswd=!0,this.showLogin=!1):this.doLogin()},doLogin(){if(this.isOAuth&&this.oauthEnv)this.handleOAuthLogin();else{if(this.isReLogin)return this.needPswd=!1,void(this.showLogin=!0);if(!this.isMulti&&this.getLiveRoomInfo.isGuestLogin)return this.needPswd=!1,this.showLogin=!1,void this.handleGuestLogin();if(this.isMulti&&this.getMultiRoomUserInfo&&this.getMultiRoomUserInfo.username&&this.getMultiRoomUserInfo.password)return this.needPswd=!1,this.showLogin=!1,void this.handleMultiRoomsLogin();this.form.username&&this.form.password&&this.getLiveRoomInfo&&this.getLiveRoomInfo.extValue&&this.getLiveRoomInfo.extValue.userAutoLogin?this.handleLogin():(this.needPswd=!1,this.showLogin=!0)}},assignLoginData(e){let t;return e?(e.username=e.username.trim().toUpperCase(),t={...e}):(t={},t.isGuest=!0),t.roomId=this.getLiveRoomInfo.id,t.loginType=this.isMobile?5:2,this.parentUserName&&(t.pun=this.parentUserName),t},handleOAuthLogin(){let e=window.location.protocol+"//"+window.location.host;/\/+$/.test(e)&&(e=e.replaceAll(/\/+$/g,""));let t=encodeURIComponent(e+"/oauthLogin");h.A.oauthRedirect({type:this.oauthEnv,redirectUrl:t}).then(e=>{window.location.href=e.msg}).catch(e=>{console.log(e),(0,a.bI)("登陆失败","error")})},handlePhoneLogin(){return this.$refs.loginForm.validate(e=>{if(e){let e=this.assignLoginData(this.form);(0,l.wu)(e).then(e=>{const{data:t}=e;this.processLoginResponse(t)})}}),!1},handleLogin(){return this.$refs.loginForm.validate(e=>{if(e){let e=this.assignLoginData(this.form);(0,l.e0)(e).then(e=>{const{data:t}=e;this.processLoginResponse(t)})}}),!1},handleGuestLogin(){let e=this.assignLoginData(),t=this.getGuestLoginInfo;t&&(t.username||t.userName)&&(e.username=t.username||t.userName,e.needPwd=1==this.getLiveRoomInfo.needPswd,e.needPwd&&(e.password=t.password),e.userNo=t.userNo),(0,l.Mk)(e).then(e=>{if("200"==e.code){const{data:t}=e;this.processLoginResponse(t,!0)}})},handleMultiRoomsLogin(){let e=this.assignLoginData(),t=this.getMultiRoomUserInfo;e.isGuest=!1,e.type=t.type,t&&t.username&&(e.username=t.username,e.password=t.password),(0,l.AT)(e).then(e=>{if("200"==e.code){const{data:t}=e;this.processLoginResponse(t,!1)}})},processLoginResponse(e,t){if((this.form.username||this.form.phone)&&this.form.password){let e=Object.assign({},this.form);this.isPhoneLogin&&(e.isPhoneLogin=!0),this.$store.dispatch("storeLoginInfo",e)}if(t){let t=Object.assign({},this.form);this.isPhoneLogin&&(t.isPhoneLogin=!0),t.username=e.userInfo.userName,t.password=e.userInfo.password,this.$store.dispatch("storeGuestLoginInfo",t),this.$store.dispatch("setGuestInfo",e.userInfo)}else this.$store.dispatch("setUserInfo",e.userInfo);this.$store.dispatch("setClientInfo",e.clientInfo),this.$store.dispatch("setToken",e.token),this.$store.dispatch("setForceAccountLogin",!1),this.$store.commit("setReLogin",!1),this.prepare()},handleLivePswd(){let e=this;return this.live.id=this.getLiveRoomInfo.id,(0,l.nG)(this.live).then(t=>{t.data?(e.showLogin=!0,e.needPswd=!1,e.doLogin()):(0,a.bI)("直播间密码错误","error")}).catch(e=>{console.error(e)}),!1}}},m=u;var d=o(81656),c=(0,d.A)(m,i,s,!1,null,"71a4072e",null);const L=c.exports}}]);